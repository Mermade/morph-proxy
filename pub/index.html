<html>
	<head>
		<title>Morph-Proxy</title>
		<link rel="stylesheet" type="text/css" href="/css/smart-green.css" media="screen">
		<link rel="stylesheet" type="text/css" href="/css/tabbed-panels.css" media="screen">

		<script src="https://code.jquery.com/jquery-1.12.3.min.js" integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>

		<script src="/dynamic/env.js"></script>
	<head>
	<body>
		<form class="smart-green">
			<h1>Morph-Proxy</h1>
			<h2>Configuration and test. <a href="https://github.com/Mermade/morph-proxy">GitHub project.</a></h2>
			<label for="owner">
				<span>Owner</span><span class="required">&nbsp;*</span>
				<input id="owner" type="text"/>
			</label>
			<label for="scraper">
				<span>Scraper</span><span class="required">&nbsp;*</span>
				<input id="scraper" type="text" />
			</label>
			<label for="format">
				<span>Format</span><span class="required">&nbsp;*</span>
				<select id="format">
					<option value="json">JSON</option>
					<option value="atom">ATOM</option>
					<option value="csv">CSV</option>
				</select>
			</label>
			<label>
				<span>&nbsp;</span>
				<input id="btnTest" type="button" class="button" value="Test Connection" />
			</label>
			<div id="labCanned">
				<label for="canned">
					<span>Canned query</span><span id="spnCannedReq" class="required">&nbsp;*</span>
					<select id="canned">
					</select>
				</label>
			</div>

			<div class="tabbed">
			  <input name="tabbedA" id="tabbed1" type="radio" checked>
			  <section>
				<h1>
				  <label for="tabbed1">Query</label>
				</h1>
				<div>
					<label for="query">
						<span>Query</span><span class="required">&nbsp;*</span>
						<textarea id="query"></textarea>
					</label>
				</div>
			  </section>
			  <input name="tabbedA" id="tabbed2" type="radio">
			  <section>
				<h1>
				  <label for="tabbed2">Endpoint</label>
				</h1>
				<div>
					<label for="endpoint">
						<span>Endpoint (nb No API KEY variable is required)</span>
						<textarea id="endpoint" disabled="true"></textarea>
					</label>
				</div>
			  </section>
			  <input name="tabbedA" id="tabbed3" type="radio">
			  <section>
				<h1>
				  <label for="tabbed3">Response</label>
				</h1>
				<div>
					<label for="response">
						<span>Response</span>
						<textarea id="response" disabled="true"></textarea>
					</label>
				</div>
			  </section>
			  <input name="tabbedA" id="tabbed4" type="radio">
			  <section>
				<h1>
				  <label for="tabbed4">Code Samples</label>
				</h1>
				<div>
					<div class="tabbed">
					  <input name="tabbedB" id="tabbedB1" type="radio" checked>
					  <section>
						<h1>
						  <label for="tabbedB1">Javascript</label>
						</h1>
						<div>
							<pre>Javascript</pre>
						</div>
					  </section>
					  <input name="tabbedB" id="tabbedB2" type="radio">
					  <section>
						<h1>
						  <label for="tabbedB2">PHP</label>
						</h1>
						<div>
							<pre>PHP</pre>
						</div>
					  </section>
					</div>
				</div>
			  </section>
			</div>

			<span>
				<span>&nbsp;</span>
				<input id="btnRun" type="button" class="button" value="Run Query" />
				<span>&nbsp;</span>
				<a href="/builder.html"><input id="btnBuild" type="button" disabled="true" class="button" value="Query Builder"></a>
			</span>
		</form>
		<script>
		$(document).ready(function(){

			function validate(query) {
				var result = true;
				if ($('#owner').val() == '') {
					$('#owner').focus();
					result = false;
				}
				else if ($('#scraper').val() == '') {
					$('#scraper').focus();
					result = false;
				}
				else if ($('#format').val() == '') {
					$('#format').focus();
					result = false;
				}
				else if ((query) && ($('#query').val() == '')) {
					$('#query').focus();
					result = false;
				}
				return result;
			}

			function url(query) {
				return '/'+$('#owner').val()+'/'+$('#scraper').val()+'/data.'+$('#format').val()+
					'?query='+encodeURIComponent(query);
			}

			function setBuilderEnabled(){
				var disabled = true;
				if (($('#owner').val() != '') && ($('#scraper').val() != '') &&
					((!proxyEnv.FORMAT) || (proxyEnv.FORMAT == 'json'))) {
					disabled = false;
				}
				$('#btnBuild').attr('disabled',disabled);
			}

			$('#owner').val(proxyEnv.OWNER);
			$('#scraper').val(proxyEnv.SCRAPER);
			$('#format').select(proxyEnv.FORMAT);
			$('#query').val(proxyEnv.QUERY);
			$('#response').val('');

			if (($('#query').val()!='') || (proxyEnv.CANNED_ONLY)) {
				$('#query').attr('disabled',true);
			}
			else {
				$('#spnCannedReq').addClass('hidden');
			}

			var canned = {};
			numCanned = 0;
			for (var i in proxyEnv) {
				if ((i.startsWith('QUERY')) && (i != 'QUERY')) {
					canned[i] = proxyEnv[i];
					$('#canned')[0].options.add(new Option(i,canned[i]));
					if ($('#query').val() == '') {
						$('#query').val(canned[i]);
					}
					numCanned++; // Object.keys() not supported in all browsers
				}
			}
			if (numCanned <= 0) {
				$('#labCanned').addClass('hidden');
			}

			if ($('#owner').val()!='') {
				$('#owner').attr('disabled',true);
			}
			if ($('#scraper').val()!='') {
				$('#scraper').attr('disabled',true);
			}
			if (typeof proxyEnv.FORMAT != 'undefined') {
				$('#format').attr('disabled',true);
			}
			setBuilderEnabled();

			$('#owner').change(function(){
				setBuilderEnabled();
			});
			$('#scraper').change(function(){
				setBuilderEnabled();
			});

			$('#canned').change(function(){
				$('#query').val($(this).val());
			});

			$('#btnTest').click(function(){
				if (validate(false)) {
					var query = 'SELECT * FROM sqlite_master';
					if (!$('#query').attr('disabled')) {
						$('#query').val(query);
					}
					$('#endpoint').val(location.protocol+'//'+location.host+url(query));
					$.ajax(url(query),{
						success : function(res){
							$('#response').val(res);
						},
						error : function(res){
							$('#response').val(JSON.stringify(res,null,2));
						}
					});
				}
				else {
					alert('Please complete all mandatory fields');
				}
				return false;
			});

			$('#btnRun').click(function(){
				if (validate(true)) {
					$('#endpoint').val(location.protocol+'//'+location.host+url($('#query').val()));
					$.ajax(url($('#query').val()),{
						success : function(res){
							$('#response').val(res);
						},
						error : function(res){
							$('#response').val(JSON.stringify(res,null,2));
						}
					});
				}
				else {
					alert('Please complete all mandatory fields');
				}
				return false;
			});
		});
		</script>
	</body>
</html>